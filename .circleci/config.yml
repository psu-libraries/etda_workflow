version: 2.1


jobs:
  prepare:
    docker:
      - image: circleci/ruby:2.6.0-jessie-node
        environment:
          BUNDLE_PATH: vendor/bundle
    steps:
    - setup_remote_docker
    - checkout

    - restore_cache:
        keys:
          - bundle-{{ checksum "Gemfile.lock" }}

    - run:
        name: "Install Ruby Dependencies"
        command: |
          bundle check --path vendor/bundle || bundle

    - save_cache:
        key: bundle-{{ checksum "Gemfile.lock" }}
        paths:
          - vendor/bundle

    - restore_cache:
        keys:
          - yarn-{{ checksum "yarn.lock" }}

    - run:
        name: "Yarn Install"
        command: yarn install --cache-folder ~/.cache/yarn

    - save_cache:
        key: yarn-{{ checksum "yarn.lock" }}
        paths:
          - ~/.cache/yarn

    - persist_to_workspace:
        root: .
        paths:
          - vendor/bundle
          - node_modules
  rubocop:
    docker:
      - image: circleci/ruby:2.6.0-jessie-node
        environment:
          BUNDLE_PATH: vendor/bundle
    steps:
    - run:
        name: "Rubocop"
        command: |
          bundle exec rubocop
          RAILS_ENV=test PARTNER=milsch docker-compose run --name=test --service-ports test /etda_workflow/bin/ci-rspec

workflows:
  version: 2
  etda-workflow:
    jobs:
      - prepare
      - rubocop:
          requires:
            - prepare
      - test_grad