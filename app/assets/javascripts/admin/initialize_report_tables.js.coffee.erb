#= require dataTables.js
#= require dataTables.bootstrap.js

setup_report_tables = () ->

    table = $('.datatable')

    return unless table.length

    report_common_options = {
        ajax: table.attr('data-ajax-url')
        processing: true
        pageLength: 25
        stateSave: true
        stateDuration: 60 * 60 * 24
        #serverSide: true
        #columnDefs: {"visible": false, "targets": 2}
        paginate: false
        language:
            loadingRecords: '&nbsp;'
            processing: "<img src='<%= image_path('spinner.gif') %>' alt='Loading data...' /> Loading data..."
        fnDrawCallback: () -> $('.committee-list').each (i, obj) ->
          obj.nextSibling.textContent = ' ' if obj.nextSibling
          return
    }

    column_options = ->
        table.find('th').map ->
            column = $(this)
            { "name": column.data('name'), "orderable": column.data('orderable'), "visible": column.data('visible') }

    $('.committee-report-index.datatable').dataTable(
        committee_report_options = {
             columns: column_options()
             rowCallback: (row, committee_report_data) ->
                 id = committee_report_data[0]
                 $(row).attr('data-submission-id', id)
             initComplete: ->
                 column = @api().column("semester_year:name")
                 current_semester = $(this).data('current-semester')
                 select = $('.semester').on('change', ->
                     val = $.fn.dataTable.util.escapeRegex($(this).val() || '')
                     column.search( (if val then '^' + val + '$' else '') , true, false).draw()
                     return
                 )

                 selected_item = current_semester

                 select.val(selected_item).change()

                 $filters = $("#row-selection-buttons") #$(@api().table().container()).find('.dataTables_filter')

                 select.val(selected_item).prop('selected', true)
        }
        $.extend(committee_report_options, report_common_options)
    )

    $('.custom-report-index.datatable').dataTable(
        custom_report_options = {
            columns: column_options()
            rowCallback: (row, custom_report_data) ->
                id = custom_report_data[0]
                $(row).attr('data-submission-id', id)
            initComplete: ->
                column = @api().column("semester_year:name")
                current_semester = $(this).data('current-semester')
                select = $('.semester').on('change', ->
                    val = $.fn.dataTable.util.escapeRegex($(this).val() || '')
                    column.search( (if val then '^' + val + '$' else '') , true, false).draw()
                    return
                )

                selected_item = current_semester

                select.val(selected_item).change()

                $filters = $("#row-selection-buttons") #$(@api().table().container()).find('.dataTables_filter')

                select.val(selected_item).prop('selected', true)
        }
        $.extend(custom_report_options, report_common_options)
    )

    #$('div.dataTables_filter input').attr('placeholder', 'Search records...')

#    $('.csv').on 'click',  ->
#         fields = $('#row-selection-buttons').find('input[name="submission_ids"]')
#        ids = selected_ids()
#        fields.val(ids)

$(document).on('page:load ready', setup_report_tables)
