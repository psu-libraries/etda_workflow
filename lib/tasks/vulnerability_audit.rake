# frozen_string_literal: true
require 'bundler/audit/task'

namespace :audit do
  desc "Check gems and yarn for vulnerabilities; this task is used for whenever"
  task vulnerabilities: :environment do
    time_out = Time.zone.now.to_s
    gem_output = `bundle exec bundle audit check --update`
    yarn_output = `yarn audit`
    final_output = gem_output + yarn_output + '--- at ' + time_out
    send_audit_notification(final_output) unless no_vulnerabilities_found(final_output)
    puts final_output
  end

  def no_vulnerabilities_found(final_output)
    if final_output.include?('No vulnerabilities found') && final_output.include?('0 vulnerabilities found')
      return true
    end
    false
  end

  def send_audit_notification(output)
    WorkflowMailer.vulnerability_audit_email(output.remove('\n', '<br>')).deliver
  end
end
